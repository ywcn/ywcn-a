<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç‰©æµç®¡ç†ç³»ç»Ÿ</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.4.0/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --bg-color: #fff;
      --text-color: #000;
      --primary-color: #4a90e2;
    }
    body.dark-mode {
      --bg-color: #1e1e1e;
      --text-color: #fff;
      --primary-color: #007acc;
    }
    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      transition: background-color 0.3s, color 0.3s;
    }
    .container { max-width: 1000px; margin: auto; }
    h1 { text-align: center; }
    .card {
      background: var(--bg-color);
      border: 1px solid #ccc;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .form-group { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
    .form-group label { width: 100px; text-align: right; }
    .form-group input, .form-group select {
      flex: 1; padding: 6px; border-radius: 5px; border: 1px solid #ccc;
    }
    button {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      background-color: var(--primary-color);
      color: white;
      cursor: pointer;
    }
    button:hover { background-color: #357ab8; }
    table { width: 100%; border-collapse: collapse; }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th { background: #f2f2f2; }
    .theme-toggle { position: absolute; top: 10px; right: 20px; cursor: pointer; }
    .stats { font-weight: bold; margin-bottom: 10px; }
  </style>
</head>
<body>
  <div class="theme-toggle" onclick="toggleTheme()">ğŸŒ“ åˆ‡æ¢æ¨¡å¼</div>
  <div class="container">
    <h1>ğŸ“¦ ç‰©æµä¿¡æ¯ç®¡ç†</h1>

    <div class="card">
      <div class="form-group">
        <label>å®¢æˆ·æœç´¢ï¼š</label>
        <input type="text" id="searchName" placeholder="è¾“å…¥å®¢æˆ·åå…³é”®è¯" />
        <label>èµ·å§‹æ—¥æœŸï¼š</label>
        <input type="date" id="startDate" />
        <label>æˆªæ­¢æ—¥æœŸï¼š</label>
        <input type="date" id="endDate" />
        <button onclick="filterLogistics()">ç­›é€‰</button>
        <button onclick="resetFilter()">é‡ç½®</button>
      </div>
    </div>

    <div class="card">
      <form id="shippingForm">
        <div class="form-group">
          <label>å®¢æˆ·å§“åï¼š</label><input type="text" id="customerName" required />
          <label>ä»¶æ•°ï¼š</label><input type="number" id="shipmentCount" required />
          <label>å‘è´§æ—¥æœŸï¼š</label><input type="date" id="shipmentDate" required />
          <button type="submit">æ·»åŠ </button>
        </div>
      </form>
      <div class="form-group">
        <label>æ‰¹é‡å¯¼å…¥ï¼š</label>
        <input type="file" id="importFile" accept=".xlsx" />
        <button onclick="importFromExcel()">å¯¼å…¥</button>
        <button onclick="exportToExcel()">å¯¼å‡º</button>
      </div>
    </div>

    <div class="card">
      <div class="stats" id="summaryText">å…± 0 æ¡è®°å½•ï¼Œæ€»å‘è´§ 0 ä»¶</div>
      <table>
        <thead>
          <tr><th>#</th><th>å®¢æˆ·å§“å</th><th>ä»¶æ•°</th><th>å‘è´§æ—¥æœŸ</th><th>æ“ä½œ</th></tr>
        </thead>
        <tbody id="logisticsTableBody"></tbody>
      </table>
    </div>
  </div>

<script type="module">
  const supabase = window.supabase.createClient(
    'https://mdgczfpcturvgtxjzrfc.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1kZ2N6ZnBjdHVydmd0eGp6cmZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM5OTgzMDMsImV4cCI6MjA1OTU3NDMwM30.5hBnXg0N3y-yhL7Ymm6AKFsatho2EsGSf_Fqfr61uKc'
  );



  let logisticsData = [];

  async function loadLogistics() {
    const { data } = await supabase.from("logistics").select("*").order("shipment_date", { ascending: false });
    logisticsData = data || [];
    renderTable(logisticsData);
  }

  function renderTable(data) {
    const tbody = document.getElementById("logisticsTableBody");
    const summary = document.getElementById("summaryText");
    tbody.innerHTML = "";
    let total = 0;
    data.forEach((item, i) => {
      total += item.shipment_count;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i + 1}</td>
        <td>${item.customer_name}</td>
        <td>${item.shipment_count}</td>
        <td>${item.shipment_date}</td>
        <td>
          <button onclick="editRecord('${item.id}')">ç¼–è¾‘</button>
          <button onclick="deleteRecord('${item.id}')">åˆ é™¤</button>
        </td>`;
      tbody.appendChild(tr);
    });
    summary.textContent = `å…± ${data.length} æ¡è®°å½•ï¼Œæ€»å‘è´§ ${total} ä»¶`;
  }

  document.getElementById("shippingForm").addEventListener("submit", async e => {
    e.preventDefault();
    const name = document.getElementById("customerName").value.trim();
    const count = parseInt(document.getElementById("shipmentCount").value);
    const date = document.getElementById("shipmentDate").value;
    if (!name || !count || !date) return alert("è¯·å¡«å†™å®Œæ•´");
    await supabase.from("logistics").insert([{ customer_name: name, shipment_count: count, shipment_date: date }]);
    e.target.reset();
    loadLogistics();
  });

  window.importFromExcel = async function () {
    const file = document.getElementById("importFile").files[0];
    if (!file) return alert("è¯·é€‰æ‹©æ–‡ä»¶");
    const reader = new FileReader();
    reader.onload = async e => {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: "array" });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet);
      const rows = json.map(r => ({
        customer_name: r.customer_name,
        shipment_count: parseInt(r.shipment_count),
        shipment_date: r.shipment_date
      })).filter(r => r.customer_name && r.shipment_count && r.shipment_date);
      await supabase.from("logistics").insert(rows);
      console.log("ğŸ“¥ å‡†å¤‡å¯¼å…¥çš„ rowsï¼š", rows);
      alert("å¯¼å…¥æˆåŠŸï¼š" + rows.length + " æ¡");
      loadLogistics();
    };
    reader.readAsArrayBuffer(file);
  };

  window.exportToExcel = () => {
    const ws = XLSX.utils.json_to_sheet(logisticsData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Logistics");
    XLSX.writeFile(wb, "logistics_export.xlsx");
  };

  window.deleteRecord = async id => {
    if (confirm("ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•ï¼Ÿ")) {
      await supabase.from("logistics").delete().eq("id", id);
      loadLogistics();
    }
  };

  window.editRecord = async id => {
    const record = logisticsData.find(r => r.id === id);
    const name = prompt("å®¢æˆ·å§“åï¼š", record.customer_name);
    const count = prompt("ä»¶æ•°ï¼š", record.shipment_count);
    const date = prompt("å‘è´§æ—¥æœŸï¼š", record.shipment_date);
    if (name && count && date) {
      await supabase.from("logistics").update({
        customer_name: name,
        shipment_count: parseInt(count),
        shipment_date: date
      }).eq("id", id);
      loadLogistics();
    }
  };

  window.filterLogistics = () => {
    const name = document.getElementById("searchName").value.trim();
    const start = document.getElementById("startDate").value;
    const end = document.getElementById("endDate").value;
    const filtered = logisticsData.filter(r =>
      (!name || r.customer_name.includes(name)) &&
      (!start || r.shipment_date >= start) &&
      (!end || r.shipment_date <= end)
    );
    renderTable(filtered);
  };

  window.resetFilter = () => {
    document.getElementById("searchName").value = "";
    document.getElementById("startDate").value = "";
    document.getElementById("endDate").value = "";
    renderTable(logisticsData);
  };

  function toggleTheme() {
    document.body.classList.toggle("dark-mode");
    localStorage.setItem("theme", document.body.classList.contains("dark-mode") ? "dark" : "light");
  }
 // æ³¨å†Œä¸ºå…¨å±€å‡½æ•°
  window.toggleTheme = toggleTheme;
  window.onload = () => {
    if (localStorage.getItem("theme") === "dark") document.body.classList.add("dark-mode");
    loadLogistics();
  };
  

</script>
</body>
</html>
