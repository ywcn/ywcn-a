<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>客户管理系统</title>
  <link rel="icon" href="./img/恐龙.png">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f4f4f4; }
    input { margin-right: 8px; }
    .header { display: flex; justify-content: space-between; align-items: center; }
    .avatar { border-radius: 50%; width: 40px; height: 40px; }
  </style>
</head>
<body>
  <div class="header">
    <h2>客户信息管理</h2>
    <div id="user-info"></div>
  </div>

  <form id="form">
    <input placeholder="姓名" id="姓名" required />
    <input placeholder="电话" id="电话" required />
    <input placeholder="地址" id="地址" required />
    <input placeholder="数量" id="数量" />
    <input placeholder="服务" id="服务" />
    <input placeholder="笔记" id="笔记" />
    <input placeholder="时间" id="时间" />
    <input placeholder="订单" id="订单" type="number" />
    <button type="submit">添加客户</button>
  </form>

  <table>
    <thead>
      <tr>
        <th>序号</th>
        <th>姓名</th>
        <th>电话</th>
        <th>地址</th>
        <th>数量</th>
        <th>服务</th>
        <th>笔记</th>
        <th>时间</th>
        <th>订单</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody id="data-body"></tbody>
  </table>

  <!-- 音效元素 -->
    <audio id="avatarSound" src="./voice/董昱昆 - 微博提示音.ogg" preload="auto"></audio>
   <audio id="warningSound" src="./voice/阿茶暖暖 - 警报声-游戏提示音.ogg" preload="auto"></audio>

  <script>
    const supabase = supabase.createClient(
      'https://mdgczfpcturvgtxjzrfc.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1kZ2N6ZnBjdHVydmd0eGp6cmZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM5OTgzMDMsImV4cCI6MjA1OTU3NDMwM30.5hBnXg0N3y-yhL7Ymm6AKFsatho2EsGSf_Fqfr61uKc'
        
    );

    const deleteSound = document.getElementById('deleteSound');
    document.addEventListener('click', () => {
      deleteSound.muted = true;
      deleteSound.play().then(() => {
        deleteSound.pause();
        deleteSound.muted = false;
      });
    }, { once: true });

    async function getUserInfo() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return location.href = "login.html";

      const { user } = session;
      const { data: userData } = await supabase
        .from("users")
        .select("*")
        .eq("id", user.user_metadata.sub)
        .single();

      document.getElementById("user-info").innerHTML = `
        <span>${userData.name}</span>
        <img class="avatar" src="${userData.avatar}" title="${userData.name}" />
        <button onclick="logout()">登出</button>
      `;
    }

    async function logout() {
      await supabase.auth.signOut();
      location.reload();
    }

    async function loadData() {
      const { data, error } = await supabase.from("customers").select("*").order("id", { ascending: true });
      const tbody = document.getElementById("data-body");
      tbody.innerHTML = "";
      data.forEach((row, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${row.姓名}</td>
          <td>${row.电话}</td>
          <td>${row.地址}</td>
          <td>${row.数量 || ""}</td>
          <td>${row.服务 || ""}</td>
          <td>${row.笔记 || ""}</td>
          <td>${row.时间 || ""}</td>
          <td>${row.订单 || ""}</td>
          <td><button onclick="deleteRow(${row.id})">删除</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function deleteRow(id) {
      await supabase.from("customers").delete().eq("id", id);
      deleteSound.play();
      loadData();
    }

    document.getElementById("form").onsubmit = async e => {
      e.preventDefault();
      const fields = ["姓名", "电话", "地址", "数量", "服务", "笔记", "时间", "订单"];
      const formData = {};
      for (let field of fields) {
        const val = document.getElementById(field).value;
        formData[field] = val || null;
      }

      const { error } = await supabase.from("customers").insert([formData]);
      if (!error) {
        e.target.reset();
        loadData();
      } else {
        alert("添加失败：" + error.message);
      }
    };

    getUserInfo();
    loadData();
  </script>
</body>
</html>
