<!DOCTYPE html>
<html lang="zh">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panda Login Form | Coding Vibess</title>
    <link rel="icon" href="./img/恐龙.png">
    <link rel="stylesheet" href="panda.css">
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
    <!-- Stylesheet -->
</head>

<body>
    <div class="container">
        <form>
            <label for="username">Username</label>
            <input type="text" id="username" placeholder="Enter username" /><br />
            <label for="password">Password</label>
            <input type="password" id="password" placeholder="Password" /><br />
            <button class="login-btn">Login</button>

            <div id="errorMsg" class="error"></div>
        </form>

        <div class="ear-l"></div>
        <div class="ear-r"></div>
        <div class="panda-face">
            <div class="blush-l"></div>
            <div class="blush-r"></div>
            <div class="eye-l">
                <div class="eyeball-l"></div>
            </div>
            <div class="eye-r">
                <div class="eyeball-r"></div>
            </div>
            <div class="nose"></div>
            <div class="mouth"></div>
        </div>
        <div class="hand-l"></div>
        <div class="hand-r"></div>
        <div class="paw-l"></div>
        <div class="paw-r"></div>

    </div>


    <!-- Script -->
    <script type="module">

        const usernameRef = document.getElementById("username");
        const passwordRef = document.getElementById("password");
        const errorDiv = document.getElementById("errorMsg");
        const btn = document.querySelector('.login-btn');

        const eyeL = document.querySelector(".eyeball-l");
        const eyeR = document.querySelector(".eyeball-r");
        const handL = document.querySelector(".hand-l");
        const handR = document.querySelector(".hand-r");

        // 眼睛与手的动画处理
        const normalEyeStyle = () => {
            eyeL.style.cssText = `left:0.6em; top: 0.6em;`;
            eyeR.style.cssText = `right:0.6em; top:0.6em;`;
        };
        const normalHandStyle = () => {
            handL.style.cssText = `height: 2.81em; top:8.4em; left:7.5em; transform: rotate(0deg);`;
            handR.style.cssText = `height: 2.81em; top:8.4em; right:7.5em; transform: rotate(0deg);`;
        };

        usernameRef.addEventListener("focus", () => {
            eyeL.style.cssText = `left: 0.75em; top: 1.12em;`;
            eyeR.style.cssText = `right: 0.75em; top: 1.12em;`;
            normalHandStyle();
        });

        passwordRef.addEventListener("focus", () => {
            handL.style.cssText = `height: 6.56em; top: 3.87em; left: 11.75em; transform: rotate(-155deg);`;
            handR.style.cssText = `height: 6.56em; top: 3.87em; right: 11.75em; transform: rotate(155deg);`;
            normalEyeStyle();
        });

        document.addEventListener("click", (e) => {
            if (e.target !== usernameRef && e.target !== passwordRef) {
                normalEyeStyle();
                normalHandStyle();
            }
        });

        // 默认用户初始化
        if (!localStorage.getItem("allUsers")) {
            const defaultUsers = {
                "admin": { password: "123456", avatar: "https://i.pravatar.cc/40?u=admin", name: "管理员" },
                "user1": { password: "abc123", avatar: "https://i.pravatar.cc/40?u=xiaoli", name: "用户1" }
            };
            localStorage.setItem("allUsers", JSON.stringify(defaultUsers));
        }

        const supabaseUrl = 'https://mdgczfpcturvgtxjzrfc.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1kZ2N6ZnBjdHVydmd0eGp6cmZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM5OTgzMDMsImV4cCI6MjA1OTU3NDMwM30.5hBnXg0N3y-yhL7Ymm6AKFsatho2EsGSf_Fqfr61uKc';

        async function login() {
    const username = usernameRef.value.trim();
    const password = passwordRef.value.trim();

    if (!username || !password) {
        errorDiv.textContent = "用户名和密码不能为空";
        return;
    }

    const { data, error } = await supabase.auth.signInWithPassword({
       username: `${username}@example.com`, // 或用username字段
        password: password
    });

    if (error) {
        errorDiv.textContent = error.message;
        return;
    }

    localStorage.setItem("loggedInUser", JSON.stringify({
        id: data.user.id,
        name: data.user.user_metadata.name,
        avatar: data.user.user_metadata.avatar
    }));

    window.location.href = "index.html";
}

        const username = usernameRef.value.trim();
        const password = passwordRef.value.trim();

        if (!username || !password) {
            errorDiv.textContent = "用户名和密码不能为空";
            return;
        }

        btn.disabled = true;
        btn.textContent = '登录中...';

        try {
            const res = await fetch(`${supabaseUrl}/rest/v1/users?username=eq.${username}`, {
                headers: {
                    apikey: supabaseKey,
                    Authorization: `Bearer ${supabaseKey}`
                }
            });

            const data = await res.json();

            if (data.length !== 1) {
                errorDiv.textContent = "用户名不存在";
            } else if (data[0].pwd !== password) {
                errorDiv.textContent = "密码错误";
            } else {
                // 登录成功，保存信息并跳转
                const user = data[0];
                localStorage.setItem("loggedInUser", JSON.stringify({
                    username: user.username,
                    name: user.name,
                    avatar: user.avatar
                }));
                window.location.href = "index.html";
            }

        } catch (err) {
            console.error("登录出错:", err);
            errorDiv.textContent = "网络错误，请稍后再试";
        }

        btn.disabled = false;
        btn.textContent = '登录';
}


        // 提交表单绑定 login()
        document.querySelector("form").addEventListener("submit", e => {
            e.preventDefault();
            login();
        });


    </script>
</body>

</html>
